# Architecture

## Содержание


## структура папок проекта
/udsu_assistance
- /src
    - /bot                   ( VK ботов )
    - /backend               ( серверная часть (API) )
    - /llm                   ( офлайн-модель )
    - /db                    ( база знаний / данные )
        - faq_list.txt        ( список первоначальных тем, вопросов и ответов )
        - udsu_assistance_bd.sql (база данных для импорта)
    - /tests                 ( тесты проекта )
- /docs                  ( документация )
    - /Specification.md     ( подробности работы условные)
    - /Architecture.md         ( Технические подробности работы приложения )
    - /DB.md
    - /Concept.md           ( концепт проекта в свободном стиле )
    - /LICENSE
- /README.md


## Пайплайн работы приложения:
1) Пользователь спрашивает бота в вк
2) бот берет сообщение и кидает его в бэкенд
3) бэкенд кидает сообщение в нейронку обученную
4) нейронка понимает контекст сообщения и выдает обратно в бэкенд теги для вывода ответа и сопроводительный текст
5) бэкенд по тегам вытягивает информацию из базы данных, формирует ответ для бота и кадает сообщение боту
6) бот кидает это всё пользователю
7) пользователь получает верное сообщение и счастливый идет дальше

## базовые структуры

### структура vk_button
{
    "action": {
        "type": "callback",
        "payload": "tag",       // это информация, которая обработается ботом внутри, 
                                    //пользак её не видит, то есть здесь должен быть полный tag как в бд
        "label": "tag_text"     // текст из тэга, каторый увидит пользователь
    },
    "color": "primary"
}

### структура json_request для post запроса от бота к серверу
{
    "user_id": "user_id"
    "type": "text" | "tag" | "user",    // request - текстовый запрос пользователя, data="текст запроса пользователя"
                                        // tag - нажатие на кнопку тега, data="payload от тега"
                                        // user - нажатие на /start, data="vk_id пользователя"
    "data": "data"    
}

### структура json_response для post ответа от сервера к боту
{
    "result": "ok" | "error",
    "data"?: {
        "text": "text"      // базовый текст, который видит пользователь
        "buttons": [        // кнопки, которые бот получает по контексту от сервера
            vk_button,
            ...
        ]
    },
    "error"?: {                 // только когда ошибка
        "code": "error_code",
        "text": "error_text"
    }
}

### структура llm_answer
{
    text: "text"                    // текст нейроный с ответом на вопрос
    path: "tag/podtag/podpodtag"    // путь из тегов состоящий из элементов дерева информации
}

## Вк бот
### Язык: Python, (lib: vk_api)
### Требования к боту:
1) отдавать сообщения от пользователя в бэкенд.
2) принимать сообщения от бэкенда и отправлять их обратно пользователю.
### подробно
1) бот запускается и выводит в начале кнопку "/start" для пользователя
2) бот игнорирует любые сообщения кроме "/start" от пользователя
3) при нажатии на кнопку "/start", бот отправляет запрос в бд (json_request, type="user")
4) бот принмает сообщение от пользователя
5) бот отправляет пост запрос с сообщением (json_request, type="request") на url сервера(config.py)
6) бот ждет ответа от сервера ( json_response )
7) бот получает ответ, если result = "error" -> 8, если result = "ok" -> 9 
8) бот выводит пользователю текст "что-то пошло не так...", и в консоли пишет код ошибки и ошибку //dev пока в разработке то можно выводить текст ошибки пользователю для удобства отладки
9) бот выводит сообщение пользователю, состоит из текста и кнопок(если они есть)
10) бот ждет действия пользователя, если новый текстовый запрос -> 4, если нажатие на кнопку -> 11
11) бот обрабатывает нажатие на кнопку и отправляет в бэк соответствующий запрос (json_request, type="tag") дальше -> 6

## бэкенд
### язык: TypeScript
### Требования к бэкенду:
1)	принимает запрос от пользователя
3)	отдавать запрос в нейронку и получать ответ от нейронки
4)	должен уметь отдавать запрос на получение данных из бд и получать его
5)	Формировать конечное сообщение, основанное на тексте полученного от нейронки и информации полученной от запроса из бд

### подробно
1) сервер получает пост запрос от бота (json_request)
2) серве различает тип сообщения type="user" -> 3, type="request" -> 4, type="tag" -> 9
3) сервер кидает запрос в бд, на наличие vk_id в таблице users и возвращает (json_responce)
4) сервер кидает текст в нейронку и получает путь из тегов
5) сервер делает запрос в бд, на получение из topics элемента, где path="ответ_нейронки"
6) сервер получает ответ от бд, если элемент найден -> 7, если нет -> 4 (повторить 3 раза в случае неудачи, если после 3 неучад не найдено -> 10)
7) сервер делает запрос на получаение детей элемента в бд
8) сервер отправляет ответ (json_responce), где text="текст нейронки", buttons=[json формы кнопок сделанные по инфе запроса на получение детей], дальше -> 1
9) сервер кидает запрос на получение элемента в бд из topics, где path="полученный путь от кнопки" -> 6 
10) сервер выдает ответ(json_respons, result="ok") с текстом "не удалось найти информацию"

## нейросеть
### Требования к нейронке:
1)	принятое сообщение разбирать на темы и контекст, и выдавать ответ из последовательности тегов и текстового сообщения для пользователя
### Подробно
1) создается новый чат
2) в нейронку отправлятся 2 заготовленных промпта и 1 промпт от сервера
1-ый промпт - объясняется роль нейронки, что она делает, какой формат ответа она выдает и тд
2-ой промпт - дает нейронке файл с древовидной структурой информации и самой информацией
3-ий промпт - запрос от сервера
3) нейронка выдает в ответ ( llm_answer )
 
## База данных
### тип: PostgreSQL
### требования:
1) Должна быть
